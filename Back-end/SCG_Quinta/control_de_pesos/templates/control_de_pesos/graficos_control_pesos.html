{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gráficos Control de Pesos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com"> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="{% static 'control_de_pesos/estilos_graficos_control_pesos.css' %}">
  <link rel="icon" href="{% static 'control_de_pesos/images/logoquinta2.png' %}" />

  <!-- Chart.js + adapter de tiempo -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="login">
    <img src="{% static 'control_de_pesos/images/logoquinta.png' %}" alt="logo" class="logo">
    <div class="login-container">
      <h1 class="title">Gráficos · Control de Pesos</h1>
    </div>

    <!-- FILTROS -->
    <div class="card">
      <div class="filtros">
        <div>
          <label>Cliente</label>
          <select id="f-cliente">
            <option value="">Todos</option>
            {% for c in clientes %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Producto</label>
          <select id="f-producto" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label>Turno</label>
          <select id="f-turno">
            <option value="">Todos</option>
            {% for t in turnos %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Lote</label>
          <input id="f-lote" type="text" placeholder="Ej: 240915-01" />
        </div>
        <div>
          <label>Desde</label>
          <input id="f-desde" type="date" />
        </div>
        <div>
          <label>Hasta</label>
          <input id="f-hasta" type="date" />
        </div>
      </div>

      <div class="acciones">
        <button class="primary-button login-button" id="btn-aplicar">Aplicar filtros</button>
        <button class="primary-button login-button" id="btn-limpiar" type="button">Limpiar</button>
        <button class="primary-button login-button" id="btn-descargar" type="button">Descargar Excel</button>
        <span id="resumen" class="badge">0 registros</span>
        <span id="peso-ref" class="badge">Peso receta: –</span>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="grid">
      <div class="card">
        <h3 class="title">Serie temporal (Peso Real vs Receta)</h3>
        <div class="chart-wrap">
          <canvas id="chartLinea"></canvas>
        </div>
        <small id="nota-tolerancia" class="badge">Tolerancia ±3%</small>
      </div>

      <div class="card">
        <h3 class="title">Histograma de desviación (gr)</h3>
        <div class="chart-wrap">
          <canvas id="chartHist"></canvas>
        </div>
      </div>
    </div>

    <div class="botones" style="margin-top:16px;">
      <form class="form" action="{% url 'redireccionar_intermedio_4' %}">
        <button class="primary-button login-button">Salir</button>
      </form>
    </div>
  </div>

  <!-- Script principal -->
  <script type="module">
    if (window.__CP_INIT__) return;
    window.__CP_INIT__ = true;

    const qs = new URLSearchParams(location.search);
    const $ = id => document.getElementById(id);

    const F = {
      cliente: $('f-cliente'),
      producto: $('f-producto'),
      turno: $('f-turno'),
      lote: $('f-lote'),
      desde: $('f-desde'),
      hasta: $('f-hasta'),
      resumen: $('resumen'),
      pesoRef: $('peso-ref'),
      notaTol: $('nota-tolerancia')
    };

    const STORAGE_KEY = 'filtros_graficos_control_pesos_v1';

    function loadFilters(){
      const f = Object.fromEntries(['cliente','producto','turno','lote','desde','hasta']
        .map(k => [k, qs.get(k) || '']));
      if (!qs.toString()){
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
          Object.assign(f, saved);
        } catch(e){}
      }
      F.cliente.value = f.cliente || '';
      F.turno.value = f.turno || '';
      F.lote.value = f.lote || '';
      F.desde.value = f.desde || '';
      F.hasta.value = f.hasta || '';
      if (f.cliente) cargarProductos(f.cliente, f.producto);
    }

    function saveFilters(){
      const f = {
        cliente: F.cliente.value, producto: F.producto.value, turno: F.turno.value,
        lote: F.lote.value, desde: F.desde.value, hasta: F.hasta.value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(f));
      const qsNew = new URLSearchParams(f);
      history.replaceState(null, '', '?' + qsNew.toString());
    }

    async function cargarProductos(cliente, preselect=''){
      F.producto.innerHTML = '<option value="">Todos</option>';
      F.producto.disabled = true;
      if (!cliente) return;

      const r = await fetch(`{% url 'api_productos_por_cliente' %}?cliente=${encodeURIComponent(cliente)}`);
      const j = await r.json();
      if (j.ok){
        j.productos.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.producto;
          opt.textContent = p.producto;
          F.producto.appendChild(opt);
        });
        F.producto.disabled = false;
        if (preselect) F.producto.value = preselect;
      }
    }
    F.cliente.addEventListener('change', ()=> cargarProductos(F.cliente.value));

    // === GRÁFICOS ===
    let chartLinea, chartHist;
    const TOLERANCIA_PCT = 3;

    function destruirCharts(){
      if (chartLinea) chartLinea.destroy();
      if (chartHist) chartHist.destroy();
    }

    function calcularBandaTolerancia(pesoReceta){
      const delta = pesoReceta * (TOLERANCIA_PCT/100);
      return {min: pesoReceta - delta, max: pesoReceta + delta};
    }

    function sanitizarSerie(data){
      return data
        .map(d => ({t: new Date(d.ts), y:+d.peso_real, receta:+d.peso_receta}))
        .filter(p => !isNaN(p.t) && Number.isFinite(p.y));
    }

    function construirSerieTemporal(data){
      const ctx = document.getElementById('chartLinea').getContext('2d');
      const pts = sanitizarSerie(data);
      if (!pts.length){
        chartLinea = new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Sin datos',data:[]}]}});return;
      }

      const pesoReceta = pts.find(p => Number.isFinite(p.receta))?.receta ?? 0;
      const banda = calcularBandaTolerancia(pesoReceta);
      F.pesoRef.textContent = `Peso receta: ${pesoReceta}`;
      F.notaTol.textContent = `Tolerancia ±${TOLERANCIA_PCT}%`;

      chartLinea = new Chart(ctx,{
        type:'line',
        data:{
          datasets:[
            {label:'Peso real (gr)', data:pts.map(p=>({x:p.t,y:p.y})), borderWidth:2, pointRadius:2},
            {label:'Peso receta (gr)', data:pts.map(p=>({x:p.t,y:pesoReceta})), borderWidth:1, pointRadius:0},
            {label:'Límite inf', data:pts.map(p=>({x:p.t,y:banda.min})), borderWidth:1, pointRadius:0},
            {label:'Límite sup', data:pts.map(p=>({x:p.t,y:banda.max})), borderWidth:1, pointRadius:0}
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{x:{type:'time',time:{unit:'day'}},y:{title:{display:true,text:'gr'}}}
        }
      });
    }

    function construirHistograma(data){
      const desv = data.map(d=>d.desviacion);
      const ctx = document.getElementById('chartHist').getContext('2d');
      if (!desv.length){
        chartHist = new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Sin datos',data:[]}]}});return;
      }
      const min=Math.min(...desv), max=Math.max(...desv);
      const bins=12, step=(max-min)/bins;
      const labels=[], counts=Array(bins).fill(0);
      for(let i=0;i<bins;i++){labels.push(`${(min+i*step).toFixed(0)} a ${(min+(i+1)*step).toFixed(0)}`);}
      desv.forEach(v=>{
        let idx=Math.floor((v-min)/step);
        if(idx>=bins)idx=bins-1;
        counts[idx]++;});
      chartHist=new Chart(ctx,{
        type:'bar',
        data:{labels,datasets:[{label:'Frecuencia',data:counts}]},
        options:{responsive:true,maintainAspectRatio:false}});
    }

    async function cargarDatos(){
      const params = new URLSearchParams({
        cliente:F.cliente.value,producto:F.producto.value,turno:F.turno.value,
        lote:F.lote.value,desde:F.desde.value,hasta:F.hasta.value});
      const url=`{% url 'api_graficos_control_pesos' %}?${params}`;
      const r=await fetch(url); const j=await r.json();
      return j.ok? j.registros || [] : [];
    }

    // === DESCARGAR EXCEL ===
    function autoWidthFromRows(rows){
      const headers = Object.keys(rows[0] || {});
      return headers.map(h=>{
        let max=h.length;
        rows.forEach(r=>{const len=String(r[h]??'').length;if(len>max)max=len;});
        return {wch:Math.min(Math.max(10,max+2),40)};
      });
    }

    function descargarExcel(rows){
      if(!rows.length){alert('No hay datos para descargar.');return;}

      const wb=XLSX.utils.book_new();
      const headers=[
        ['ID','Fecha registro','Cliente','Producto','Código','Peso receta (gr)','Peso real (gr)','Desviación (gr)','Lote','Turno']
      ];
      const body=rows.map(r=>[
        r.id, r.ts?new Date(r.ts):'', r.cliente, r.producto, r.codigo_producto,
        r.peso_receta, r.peso_real, r.desviacion, r.lote, r.turno
      ]);
      const ws=XLSX.utils.aoa_to_sheet([...headers,...body]);
      ws['!cols']=autoWidthFromRows(rows);
      XLSX.utils.book_append_sheet(wb,ws,'Control de Pesos');
      XLSX.writeFile(wb,'control_pesos_filtrado.xlsx');
    }

    // === Eventos ===
    document.getElementById('btn-aplicar').addEventListener('click',async e=>{
      e.preventDefault();saveFilters();
      const data=await cargarDatos();
      F.resumen.textContent=`${data.length} registros`;
      destruirCharts();construirSerieTemporal(data);construirHistograma(data);
      window.__datosActuales=data;
    });

    document.getElementById('btn-limpiar').addEventListener('click',e=>{
      e.preventDefault();
      ['f-cliente','f-producto','f-turno','f-lote','f-desde','f-hasta'].forEach(id=>$(id).value='');
      F.producto.disabled=true;localStorage.removeItem(STORAGE_KEY);location.search='';
    });

    document.getElementById('btn-descargar').addEventListener('click',e=>{
      e.preventDefault();
      descargarExcel(window.__datosActuales||[]);
    });

    loadFilters();
  </script>
</body>
</html>