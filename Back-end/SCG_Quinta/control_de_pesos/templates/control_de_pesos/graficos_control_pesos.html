{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gráficos Control de Pesos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com"> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'control_de_pesos/estilos_r_control_de_pesos.css' %}">
  <link rel="icon" href="{% static 'control_de_pesos/images/logoquinta2.png' %}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    .filtros { display:grid; gap:12px; grid-template-columns: repeat(6, minmax(140px, 1fr)); align-items:end; }
    .acciones { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;}
    .card { background:#fff; border-radius:16px; padding:16px; box-shadow:0 4px 16px rgba(0,0,0,.08); margin-top:18px;}
    .title { font-family:Quicksand, system-ui; margin: 0 0 10px; }
    label { font-size:.9rem; font-weight:600 }
    input, select { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #ddd; }
    .grid { display:grid; gap:18px; grid-template-columns:1fr; }
    @media (min-width:1100px){ .grid{ grid-template-columns:1fr 1fr; } }
    .badge { font-size:.8rem; padding:4px 8px; border-radius:999px; background:#f2f2f2; display:inline-block; }
  </style>
</head>
<body>
  <div class="login">
    <img src="{% static 'control_de_pesos/images/logoquinta.png' %}" alt="logo" class="logo">
    <div class="login-container">
      <h1 class="title">Gráficos · Control de Pesos</h1>
    </div>

    <!-- FILTROS -->
    <div class="card">
      <div class="filtros">
        <div>
          <label>Cliente</label>
          <select id="f-cliente">
            <option value="">Todos</option>
            {% for c in clientes %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Producto</label>
          <select id="f-producto" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label>Turno</label>
          <select id="f-turno">
            <option value="">Todos</option>
            {% for t in turnos %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Lote</label>
          <input id="f-lote" type="text" placeholder="Ej: 240915-01" />
        </div>
        <div>
          <label>Desde</label>
          <input id="f-desde" type="date" />
        </div>
        <div>
          <label>Hasta</label>
          <input id="f-hasta" type="date" />
        </div>
      </div>

      <div class="acciones">
        <button class="primary-button login-button" id="btn-aplicar">Aplicar filtros</button>
        <button class="primary-button login-button" id="btn-limpiar" type="button">Limpiar</button>
        <button class="primary-button login-button" id="btn-descargar" type="button">Descargar CSV</button>
        <span id="resumen" class="badge">0 registros</span>
        <span id="peso-ref" class="badge">Peso receta: –</span>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="grid">
      <div class="card">
        <h3 class="title">Serie temporal (Peso Real vs Receta)</h3>
        <canvas id="chartLinea"></canvas>
        <small id="nota-tolerancia" class="badge">Tolerancia ±3%</small>
      </div>
      <div class="card">
        <h3 class="title">Histograma de desviación (gr)</h3>
        <canvas id="chartHist"></canvas>
      </div>
    </div>

    <div class="botones" style="margin-top:16px;">
      <form class="form" action="{% url 'redireccionar_selecciones_2' %}">
        <button class="primary-button login-button">Salir</button>
      </form>
    </div>
  </div>

  <script>
    // === Persistencia filtros (localStorage + querystring) ===
    const qs = new URLSearchParams(location.search);
    const $c = id => document.getElementById(id);

    const F = {
      cliente: $c('f-cliente'),
      producto: $c('f-producto'),
      turno: $c('f-turno'),
      lote: $c('f-lote'),
      desde: $c('f-desde'),
      hasta: $c('f-hasta'),
      resumen: $c('resumen'),
      pesoRef: $c('peso-ref'),
      notaTol: $c('nota-tolerancia'),
    };

    const STORAGE_KEY = 'filtros_graficos_control_pesos_v1';
    function loadFilters(){
      // 1) Querystring tiene prioridad
      const f = Object.fromEntries(['cliente','producto','turno','lote','desde','hasta']
        .map(k => [k, qs.get(k) || '']));
      // 2) Si no hay QS, toma localStorage
      if (!qs.toString()){
        try {
          const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
          Object.assign(f, saved);
        } catch(e){}
      }
      F.cliente.value = f.cliente || '';
      F.turno.value = f.turno || '';
      F.lote.value = f.lote || '';
      F.desde.value = f.desde || '';
      F.hasta.value = f.hasta || '';
      // Producto se carga asincrónico según cliente
      if (f.cliente) { cargarProductos(f.cliente, f.producto); }
    }
    function saveFilters(){
      const f = {
        cliente: F.cliente.value, producto: F.producto.value, turno: F.turno.value,
        lote: F.lote.value, desde: F.desde.value, hasta: F.hasta.value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(f));
      const qsNew = new URLSearchParams(f);
      history.replaceState(null, '', '?' + qsNew.toString());
    }

    // === Poblar productos por cliente desde backend ===
    async function cargarProductos(cliente, preselect=''){
      F.producto.innerHTML = '<option value="">Todos</option>';
      F.producto.disabled = true;
      if (!cliente) return;
      const r = await fetch(`{% url 'api_productos_por_cliente' %}?cliente=${encodeURIComponent(cliente)}`);
      const j = await r.json();
      if (j.ok){
        j.productos.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.producto;
          opt.textContent = p.producto;
          opt.setAttribute('data-codigo', p.codigo || '');
          F.producto.appendChild(opt);
        });
        F.producto.disabled = false;
        if (preselect){ F.producto.value = preselect; }
      }
    }

    F.cliente.addEventListener('change', () => {
      cargarProductos(F.cliente.value, '');
    });

    // === Charts ===
    let chartLinea, chartHist;
    const TOLERANCIA_PCT = 3; // ±3% editable

    function destruirCharts(){
      if (chartLinea) { chartLinea.destroy(); chartLinea = null; }
      if (chartHist)  { chartHist.destroy();  chartHist  = null; }
    }

    function calcularBandaTolerancia(pesoReceta){
      if (!pesoReceta) return {min:null, max:null};
      const delta = pesoReceta * (TOLERANCIA_PCT/100);
      return {min: pesoReceta - delta, max: pesoReceta + delta};
    }

    function construirSerieTemporal(data){
        const ctx = document.getElementById('chartLinea').getContext('2d');

        if (!data.length){
            // Dibuja un placeholder en vez de quedar en blanco
            chartLinea = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Sin datos', data: [] }] },
            options: { responsive: true }
            });
            F.pesoRef.textContent = 'Peso receta: –';
            F.notaTol.textContent = 'Sin datos';
            return;
        }

        const labels = data.map(d => new Date(d.ts));  // <- requiere el adapter
        const yReal  = data.map(d => d.peso_real);
        const pesoReceta = data[0].peso_receta ?? null; // asumiendo receta constante
        const banda = calcularBandaTolerancia(pesoReceta);

        F.pesoRef.textContent = 'Peso receta: ' + (pesoReceta ?? '–');
        F.notaTol.textContent = `Tolerancia ±${TOLERANCIA_PCT}%`;

        const datasets = [
            { label: 'Peso real (gr)', data: yReal, borderWidth: 2, pointRadius: 2 },
        ];
        if (pesoReceta){
            datasets.push({ label: 'Peso receta (gr)', data: data.map(_ => pesoReceta), borderWidth: 1, pointRadius: 0 });
        }
        if (banda.min != null && banda.max != null){
            datasets.push({ label: 'Límite inferior', data: data.map(_ => banda.min), borderWidth: 1, pointRadius: 0 });
            datasets.push({ label: 'Límite superior', data: data.map(_ => banda.max), borderWidth: 1, pointRadius: 0 });
        }

        chartLinea = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
            responsive: true,
            parsing: false,
            scales: {
                x: { type: 'time', time: { unit: 'minute' } },
                y: { title: { display: true, text: 'gr' }, beginAtZero: false }
            },
            plugins: { tooltip: { mode: 'index', intersect: false } }
            }
        });
    }

    function construirHistograma(data){
      // Desviaciones en gramos
      const desv = data.map(d => d.desviacion);
      if (!desv.length){
        const ctx = document.getElementById('chartHist').getContext('2d');
        chartHist = new Chart(ctx, { type: 'bar', data: {labels:[], datasets:[{label:'Sin datos', data:[]}]} });
        return;
      }
      // bins automáticos simples
      const min = Math.min(...desv), max = Math.max(...desv);
      const bins = 12;
      const step = Math.max(1, Math.ceil((max-min)/bins));
      const labels = [];
      const counts = new Array(bins).fill(0);
      for (let i=0;i<bins;i++){
        const a = min + i*step;
        const b = a + step;
        labels.push(`${a} a ${b}`);
      }
      desv.forEach(v => {
        let idx = Math.floor((v - min)/step);
        if (idx >= bins) idx = bins-1;
        if (idx < 0) idx = 0;
        counts[idx]++;
      });

      const ctx = document.getElementById('chartHist').getContext('2d');
      chartHist = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Frecuencia', data: counts }] },
        options: {
          responsive: true,
          scales: { x: { title:{display:true,text:'Desviación (gr)'} }, y:{ beginAtZero:true } }
        }
      });
    }

    // === Fetch datos ===
    async function cargarDatos(){
        const p = new URLSearchParams({
            cliente: F.cliente.value || '',
            producto: F.producto.value || '',
            turno: F.turno.value || '',
            lote: F.lote.value || '',
            desde: F.desde.value || '',
            hasta: F.hasta.value || ''
        });
        const url = `{% url 'api_graficos_control_pesos' %}?` + p.toString();
        try {
            const r = await fetch(url, { credentials: 'same-origin' });
            if (!r.ok){
            console.error('Error HTTP', r.status, url);
            return [];
            }
            const j = await r.json();
            if (!j.ok){
            console.error('API respondió ok=false', j);
            return [];
            }
            // Debug rápido en consola
            if (j.registros && j.registros.length){
            console.debug('Primeros registros', j.registros.slice(0,3));
            }
            return j.registros || [];
        } catch (err){
            console.error('Fallo fetch', err);
            return [];
        }
    }

    function descargarCSV(rows){
      if (!rows.length){ alert('No hay datos para descargar.'); return; }
      const headers = Object.keys(rows[0]);
      const csv = [
        headers.join(','),
        ...rows.map(o => headers.map(h => JSON.stringify(o[h] ?? '')).join(','))
      ].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'control_pesos_filtrado.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function aplicar(){
      saveFilters();
      const data = await cargarDatos();
      F.resumen.textContent = `${data.length} registros`;
      destruirCharts();
      construirSerieTemporal(data);
      construirHistograma(data);
      window.__datosActuales = data; // para CSV
    }

    // Botones
    document.getElementById('btn-aplicar').addEventListener('click', (e)=>{ e.preventDefault(); aplicar(); });
    document.getElementById('btn-limpiar').addEventListener('click', (e)=>{
      e.preventDefault();
      ['f-cliente','f-producto','f-turno','f-lote','f-desde','f-hasta'].forEach(id=>{
        const el = $c(id);
        if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
      });
      F.producto.disabled = true;
      history.replaceState(null,'',location.pathname);
      localStorage.removeItem(STORAGE_KEY);
      aplicar();
    });
    document.getElementById('btn-descargar').addEventListener('click', (e)=>{
      e.preventDefault();
      descargarCSV(window.__datosActuales || []);
    });

    // Init
    loadFilters();
    aplicar();
  </script>
</body>
</html>