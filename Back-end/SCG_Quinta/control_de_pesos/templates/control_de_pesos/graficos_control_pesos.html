{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gráficos Control de Pesos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com"> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'control_de_pesos/estilos_r_control_de_pesos.css' %}">
  <link rel="icon" href="{% static 'control_de_pesos/images/logoquinta2.png' %}" />

  <!-- Chart.js + adapter de tiempo (orden IMPORTANTE) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <style>
  /* ====== FIX BOTONES (override) ====== */
  .primary-button.login-button,
  .botones .primary-button,
  .acciones .primary-button {
    /* Reseteos para Safari/Firefox */
    -webkit-appearance: none;
    appearance: none;
    border: 0;

    /* Tacto y legibilidad */
    background: #c94a3a;          /* color corporativo/bien contrastado */
    color: #fff !important;       /* asegura contraste */
    font-weight: 700;
    font-size: 0.95rem;
    line-height: 1;
    padding: 12px 18px;
    border-radius: 12px;
    cursor: pointer;

    /* Presencia */
    box-shadow: 0 6px 14px rgba(201,74,58,.25);
    transform: translateZ(0);     /* evita blur en Safari */
    transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
  }

  .primary-button.login-button:hover,
  .botones .primary-button:hover,
  .acciones .primary-button:hover {
    background: #b84335;
    box-shadow: 0 8px 18px rgba(201,74,58,.35);
  }

  .primary-button.login-button:active,
  .botones .primary-button:active,
  .acciones .primary-button:active {
    transform: translateY(1px);
  }

  .primary-button.login-button:focus-visible,
  .botones .primary-button:focus-visible,
  .acciones .primary-button:focus-visible {
    outline: 3px solid #ffd8d3;   /* anillo de enfoque accesible */
    outline-offset: 2px;
  }

  /* Tamaño coherente en la barra de acciones */
  .acciones {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    position: relative;
    z-index: 2;                   /* por si un canvas/card la sobrepasa */
  }

  .acciones .primary-button {
    min-width: 160px;             /* mejor click target */
  }

  /* Chips de resumen/peso para que no “empujen” botones */
  .acciones .badge {
    background: #f5f5f5;
    color: #444;
    border: 1px solid #eee;
    height: 38px;
    display: inline-flex;
    align-items: center;
    padding: 0 10px;
    border-radius: 999px;
  }

  /* Botón “Salir” grande y centrado */
  .botones .primary-button {
    display: inline-block;
    min-width: 180px;
    background: #b84335;
    margin: 12px auto 0;
  }

  @media (max-width: 720px){
    .acciones .primary-button { flex: 1 1 100%; }
    .acciones .badge { width: 100%; justify-content: center; }
  }
  /* === FONDO BLANCO EN LOS GRÁFICOS === */
  .grid .card canvas {
    background: #fff !important; /* fuerza fondo blanco */
    width:100%; 
    height:100%;
  }
</style>
</head>
<body>
  <div class="login">
    <img src="{% static 'control_de_pesos/images/logoquinta.png' %}" alt="logo" class="logo">
    <div class="login-container">
      <h1 class="title">Gráficos · Control de Pesos</h1>
    </div>

    <!-- FILTROS -->
    <div class="card">
      <div class="filtros">
        <div>
          <label>Cliente</label>
          <select id="f-cliente">
            <option value="">Todos</option>
            {% for c in clientes %}
              <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Producto</label>
          <select id="f-producto" disabled>
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label>Turno</label>
          <select id="f-turno">
            <option value="">Todos</option>
            {% for t in turnos %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Lote</label>
          <input id="f-lote" type="text" placeholder="Ej: 240915-01" />
        </div>
        <div>
          <label>Desde</label>
          <input id="f-desde" type="date" />
        </div>
        <div>
          <label>Hasta</label>
          <input id="f-hasta" type="date" />
        </div>
      </div>

      <div class="acciones">
        <button class="primary-button login-button" id="btn-aplicar">Aplicar filtros</button>
        <button class="primary-button login-button" id="btn-limpiar" type="button">Limpiar</button>
        <button class="primary-button login-button" id="btn-descargar" type="button">Descargar CSV</button>
        <span id="resumen" class="badge">0 registros</span>
        <span id="peso-ref" class="badge">Peso receta: –</span>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="grid">
      <div class="card">
        <h3 class="title">Serie temporal (Peso Real vs Receta)</h3>
        <canvas id="chartLinea"></canvas>
        <small id="nota-tolerancia" class="badge">Tolerancia ±3%</small>
      </div>
      <div class="card">
        <h3 class="title">Histograma de desviación (gr)</h3>
        <canvas id="chartHist"></canvas>
      </div>
    </div>

    <div class="botones" style="margin-top:16px;">
      <form class="form" action="{% url 'redireccionar_intermedio_4' %}">
        <button class="primary-button login-button">Salir</button>
      </form>
    </div>
  </div>

  <!-- Script como módulo + guardia contra doble inicialización -->
  <script type="module">
    if (window.__CP_INIT__) {
      console.warn('Control de Pesos: script ya inicializado, salto duplicado.');
    } else {
      window.__CP_INIT__ = true;

      // === Helpers de DOM / Filtros persistentes ===
      const qs = new URLSearchParams(location.search);
      const $c = id => document.getElementById(id);

      const F = {
        cliente: $c('f-cliente'),
        producto: $c('f-producto'),
        turno: $c('f-turno'),
        lote: $c('f-lote'),
        desde: $c('f-desde'),
        hasta: $c('f-hasta'),
        resumen: $c('resumen'),
        pesoRef: $c('peso-ref'),
        notaTol: $c('nota-tolerancia'),
      };

      const STORAGE_KEY = 'filtros_graficos_control_pesos_v1';
      function loadFilters(){
        const f = Object.fromEntries(['cliente','producto','turno','lote','desde','hasta']
          .map(k => [k, qs.get(k) || '']));
        if (!qs.toString()){
          try {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            Object.assign(f, saved);
          } catch(e){}
        }
        F.cliente.value = f.cliente || '';
        F.turno.value = f.turno || '';
        F.lote.value = f.lote || '';
        F.desde.value = f.desde || '';
        F.hasta.value = f.hasta || '';
        if (f.cliente) { cargarProductos(f.cliente, f.producto); }
      }
      function saveFilters(){
        const f = {
          cliente: F.cliente.value, producto: F.producto.value, turno: F.turno.value,
          lote: F.lote.value, desde: F.desde.value, hasta: F.hasta.value
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(f));
        const qsNew = new URLSearchParams(f);
        history.replaceState(null, '', '?' + qsNew.toString());
      }

      // === Poblar productos por cliente desde backend ===
      async function cargarProductos(cliente, preselect=''){
        F.producto.innerHTML = '';
        const optTodos = document.createElement('option');
        optTodos.value = '';
        optTodos.textContent = 'Todos';
        F.producto.appendChild(optTodos);

        F.producto.disabled = true;
        if (!cliente) return;

        const r = await fetch(`{% url 'api_productos_por_cliente' %}?cliente=${encodeURIComponent(cliente)}`, { credentials: 'same-origin' });
        const ct = r.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          console.error('productos_por_cliente devolvió contenido no JSON');
          return;
        }

        const j = await r.json();
        if (j.ok){
          console.debug('Productos recibidos:', j.productos?.length || 0);
          if (!j.productos.length){
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '— Sin productos para este cliente —';
            F.producto.appendChild(opt);
            F.producto.disabled = false;
            return;
          }

          j.productos.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.producto;
            opt.textContent = p.producto;
            opt.setAttribute('data-codigo', p.codigo || '');
            F.producto.appendChild(opt);
          });
          F.producto.disabled = false;
          if (preselect){ F.producto.value = preselect; }
        }
      }

      F.cliente.addEventListener('change', () => {
        cargarProductos(F.cliente.value, '');
      });

      // === Charts ===
      let chartLinea, chartHist;
      let rendering = false; // evita renders simultáneos

      function safeDestroy(chart){
        try { if (chart && !chart._destroyed) chart.destroy(); } catch (_) {}
      }
      function destruirCharts(){
        safeDestroy(chartLinea); chartLinea = undefined;
        safeDestroy(chartHist);  chartHist  = undefined;
      }

      const TOLERANCIA_PCT = 3; // ±3% editable
      function calcularBandaTolerancia(pesoReceta){
        if (!pesoReceta && pesoReceta !== 0) return {min:null, max:null};
        const delta = pesoReceta * (TOLERANCIA_PCT/100);
        return {min: pesoReceta - delta, max: pesoReceta + delta};
      }

      // Sanitiza puntos (fecha válida + número válido)
      function sanitizarSerie(data){
        const pts = [];
        for (const d of data){
          const t = new Date(d.ts);
          const y = Number(d.peso_real);
          if (!Number.isFinite(y)) continue;
          if (isNaN(t.getTime())) continue;
          pts.push({ t, y, receta: Number(d.peso_receta) });
        }
        return pts;
      }

      // Unidad de tiempo dinámica según rango
      function unidadTiempo(labels){
        if (!labels.length) return 'day';
        const min = labels[0].getTime();
        const max = labels[labels.length - 1].getTime();
        const span = max - min;
        const H = 60 * 60 * 1000;
        const D = 24 * H;
        if (span <= 2 * H)   return 'minute'; // hasta 2 horas
        if (span <= 2 * D)   return 'hour';   // hasta 2 días
        if (span <= 90 * D)  return 'day';    // hasta 3 meses
        return 'month';
      }

      // === SERIE TEMPORAL (usa datos {x, y}) ===
      function construirSerieTemporal(data){
        const ctx = document.getElementById('chartLinea').getContext('2d');

        const ptsRaw = sanitizarSerie(data);

        if (!ptsRaw.length){
          chartLinea = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Sin datos', data: [] }] },
            options: { responsive: true, maintainAspectRatio: false }
          });
          F.pesoRef.textContent = 'Peso receta: –';
          F.notaTol.textContent = 'Sin datos';
          return;
        }

        // Datos como {x: fecha, y: valor}
        const dataRealXY = ptsRaw.map(p => ({ x: p.t, y: p.y }));

        const pesoRecetaVal = ptsRaw.find(p => Number.isFinite(p.receta))?.receta;
        const pesoReceta = Number.isFinite(pesoRecetaVal) ? pesoRecetaVal : null;
        const banda = calcularBandaTolerancia(pesoReceta);

        F.pesoRef.textContent = 'Peso receta: ' + (pesoReceta ?? '–');
        F.notaTol.textContent = `Tolerancia ±${TOLERANCIA_PCT}%`;

        const dataRecetaXY = (pesoReceta || pesoReceta === 0)
          ? ptsRaw.map(p => ({ x: p.t, y: pesoReceta }))
          : [];

        const dataMinXY = (banda.min != null)
          ? ptsRaw.map(p => ({ x: p.t, y: banda.min }))
          : [];

        const dataMaxXY = (banda.max != null)
          ? ptsRaw.map(p => ({ x: p.t, y: banda.max }))
          : [];

        const labels = ptsRaw.map(p => p.t);
        const unit = unidadTiempo(labels);

        chartLinea = new Chart(ctx, {
          type: 'line',
          data: {
            // Sin labels: datasets con pares {x,y}
            datasets: [
              { label: 'Peso real (gr)', data: dataRealXY, borderWidth: 2, pointRadius: 2 },
              ...(dataRecetaXY.length ? [{ label: 'Peso receta (gr)', data: dataRecetaXY, borderWidth: 1, pointRadius: 0 }] : []),
              ...(dataMinXY.length ? [{ label: 'Límite inferior', data: dataMinXY, borderWidth: 1, pointRadius: 0 }] : []),
              ...(dataMaxXY.length ? [{ label: 'Límite superior', data: dataMaxXY, borderWidth: 1, pointRadius: 0 }] : []),
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            parsing: true,        // Chart parsea {x,y}
            spanGaps: true,
            scales: {
              x: { type: 'time', time: { unit }, ticks: { maxTicksLimit: 12 } },
              y: { title: { display: true, text: 'gr' }, beginAtZero: false }
            },
            plugins: { tooltip: { mode: 'index', intersect: false } }
          }
        });
      }

      function construirHistograma(data){
        const desv = data.map(d => d.desviacion);
        const ctx = document.getElementById('chartHist').getContext('2d');

        if (!desv.length){
          chartHist = new Chart(ctx, { type: 'bar', data: {labels:[], datasets:[{label:'Sin datos', data:[]}]} , options:{ maintainAspectRatio:false, responsive:true }});
          return;
        }

        const min = Math.min(...desv), max = Math.max(...desv);
        const bins = 12;
        const step = Math.max(1, Math.ceil((max-min)/bins));
        const labels = [];
        const counts = new Array(bins).fill(0);
        for (let i=0;i<bins;i++){
          const a = min + i*step;
          const b = a + step;
          labels.push(`${a} a ${b}`);
        }
        desv.forEach(v => {
          let idx = Math.floor((v - min)/step);
          if (idx >= bins) idx = bins-1;
          if (idx < 0) idx = 0;
          counts[idx]++;
        });

        chartHist = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Frecuencia', data: counts }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { title:{display:true,text:'Desviación (gr)'} }, y:{ beginAtZero:true } }
          }
        });
      }

      // === Fetch datos (robusto ante redirecciones al login) ===
      async function cargarDatos(){
        const p = new URLSearchParams({
          cliente: F.cliente.value || '',
          producto: F.producto.value || '',
          turno: F.turno.value || '',
          lote: F.lote.value || '',
          desde: F.desde.value || '',
          hasta: F.hasta.value || ''
        });
        const url = `{% url 'api_graficos_control_pesos' %}?` + p.toString();
        try {
          const r = await fetch(url, { credentials: 'same-origin' });

          const ctype = r.headers.get('content-type') || '';
          if (!ctype.includes('application/json')) {
            console.error('La respuesta no es JSON (¿redirigido al login?)', r.status, url);
            alert('No pude leer datos (posible sesión expirada). Refresca la página e inicia sesión.');
            return [];
          }

          if (!r.ok){
            console.error('Error HTTP', r.status, url);
            return [];
          }
          const j = await r.json();
          if (!j.ok){
            console.error('API ok=false', j);
            return [];
          }
          if (j.registros && j.registros.length){
            console.debug('Primeros registros', j.registros.slice(0,3));
          }
          return j.registros || [];
        } catch (err){
          console.error('Fallo fetch', err);
          return [];
        }
      }

      function descargarCSV(rows){
        if (!rows.length){ alert('No hay datos para descargar.'); return; }
        const headers = Object.keys(rows[0]);
        const csv = [
          headers.join(','),
          ...rows.map(o => headers.map(h => JSON.stringify(o[h] ?? '')).join(','))
        ].join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'control_pesos_filtrado.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      }

      // Anti-concurrencia + destroy seguro
      async function aplicar(){
        if (rendering) return;
        rendering = true;

        saveFilters();
        const data = await cargarDatos();

        F.resumen.textContent = `${data.length} registros`;
        destruirCharts();

        // cede 1 frame para liberar canvas antes de crear el siguiente chart
        await new Promise(requestAnimationFrame);

        if (!data.length){
          const ctx1 = document.getElementById('chartLinea').getContext('2d');
          chartLinea = new Chart(ctx1, { type:'line', data:{labels:[], datasets:[{label:'Sin datos', data:[]}] }, options:{ maintainAspectRatio:false } });
          const ctx2 = document.getElementById('chartHist').getContext('2d');
          chartHist  = new Chart(ctx2,  { type:'bar',  data:{labels:[], datasets:[{label:'Sin datos', data:[]}] }, options:{ maintainAspectRatio:false } });
          rendering = false;
          return;
        }

        construirSerieTemporal(data);
        construirHistograma(data);
        window.__datosActuales = data;
        rendering = false;
      }

      // Botones
      document.getElementById('btn-aplicar').addEventListener('click', (e)=>{
        e.preventDefault();
        if (!rendering) aplicar();
      });
      document.getElementById('btn-limpiar').addEventListener('click', (e)=>{
        e.preventDefault();
        if (rendering) return;
        ['f-cliente','f-producto','f-turno','f-lote','f-desde','f-hasta'].forEach(id=>{
          const el = $c(id);
          if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
        });
        F.producto.disabled = true;
        history.replaceState(null,'',location.pathname);
        localStorage.removeItem(STORAGE_KEY);
        aplicar();
      });
      document.getElementById('btn-descargar').addEventListener('click', (e)=>{
        e.preventDefault();
        descargarCSV(window.__datosActuales || []);
      });

      // Init
      loadFilters();
      aplicar();
    }
  </script>
</body>
</html>