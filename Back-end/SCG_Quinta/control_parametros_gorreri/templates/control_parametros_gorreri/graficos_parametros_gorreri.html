{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gr치ficos 췅 Par치metros Gorreri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com"> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">

  <!-- Estilos (reutilizamos los del m칩dulo) -->
  <link rel="stylesheet" href="{% static 'control_de_pesos/estilos_graficos_control_pesos.css' %}">
  <link rel="icon" href="{% static 'control_parametros_gorreri/images/logoquinta2.png' %}" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3/locale/es/index.min.js" defer></script>
</head>

<body>
  <div class="login">
    <img src="{% static 'control_parametros_gorreri/images/logoquinta.png' %}" alt="logo" class="logo">
    <div class="login-container">
      <h1 class="title">Gr치ficos 췅 Control Par치metros Gorreri</h1>
    </div>

    <!-- FILTROS -->
    <div class="card">
      <div class="filtros" id="filtros">
        <div>
          <label for="f-cliente">Cliente</label>
          <select id="f-cliente">
            <option value="">Todos</option>
            {% for c in clientes %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label for="f-producto">Producto</label>
          <select id="f-producto">
            <option value="">Todos</option>
            {% for p in productos %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label for="f-tm">Turbomixer</label>
          <select id="f-tm">
            <option value="">Todos</option>
            {% for t in tms %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label for="f-turno">Turno</label>
          <select id="f-turno">
            <option value="">Todos</option>
            {% for t in turnos %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label for="f-lote">Lote</label>
          <input id="f-lote" type="text" placeholder="Ej: 241101-01" />
        </div>
        <div>
          <label for="f-desde">Desde</label>
          <input id="f-desde" type="date" />
        </div>
        <div>
          <label for="f-hasta">Hasta</label>
          <input id="f-hasta" type="date" />
        </div>
      </div>
      <div class="acciones">
        <button class="primary-button" id="btn-aplicar" type="button">Aplicar filtros</button>
        <button class="primary-button" id="btn-limpiar" type="button">Limpiar</button>
        <span id="resumen" class="badge">0 registros</span>
      </div>
    </div>

    <!-- GRILLA DE GR츼FICOS -->
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
      <div class="card">
        <h3 class="title">Velocidad Bomba (RPM)</h3>
        <div class="chart-wrap"><canvas id="chartBomba"></canvas></div>
      </div>
      <div class="card">
        <h3 class="title">Velocidad Turbo (RPM)</h3>
        <div class="chart-wrap"><canvas id="chartTurbo"></canvas></div>
      </div>
      <div class="card">
        <h3 class="title">Contrapresi칩n (bar)</h3>
        <div class="chart-wrap"><canvas id="chartContra"></canvas></div>
      </div>
      <div class="card">
        <h3 class="title">Inyecci칩n de aire (mm)</h3>
        <div class="chart-wrap"><canvas id="chartAire"></canvas></div>
      </div>
      <div class="card">
        <h3 class="title">Densidad (g/ml)</h3>
        <div class="chart-wrap"><canvas id="chartDensidad"></canvas></div>
      </div>
      <div class="card">
        <h3 class="title">Temperatura (춿C)</h3>
        <div class="chart-wrap"><canvas id="chartTemp"></canvas></div>
      </div>
    </div>

    <div class="botones" style="margin-top:16px;">
      <form class="form" action="{% url 'redireccionar_selecciones_2' %}">
        <button class="primary-button">Salir</button>
      </form>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const $ = id => document.getElementById(id);
    const F = {
        cliente: $('f-cliente'),
        producto: $('f-producto'),
        tm: $('f-tm'),
        turno: $('f-turno'),
        lote: $('f-lote'),
        desde: $('f-desde'),
        hasta: $('f-hasta'),
        resumen: $('resumen'),
    };
    const STORAGE_KEY = 'filtros_graficos_parametros_gorreri_v1';

    let chartBomba, chartTurbo, chartContra, chartAire, chartDensidad, chartTemp;

    // 游댳 NUEVO: cargar productos seg칰n cliente
    async function cargarProductosPorCliente(cliente, preselect = '') {
        // deja siempre la opci칩n "Todos"
        F.producto.innerHTML = '<option value="">Todos</option>';
        if (!cliente) {
        return;
        }
        try {
        const r = await fetch(`{% url 'api_productos_por_cliente_parametros_gorreri' %}?cliente=${encodeURIComponent(cliente)}`, {
            credentials: 'same-origin'
        });
        const ct = r.headers.get('content-type') || '';
        if (!ct.includes('application/json')) return;
        const j = await r.json();
        if (j.ok) {
            (j.productos || []).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.producto;
            opt.textContent = p.producto;
            F.producto.appendChild(opt);
            });
            if (preselect) {
            F.producto.value = preselect;
            }
        }
        } catch (err) {
        console.error('Error cargando productos por cliente:', err);
        }
    }

    function loadFilters(){
        const qs = new URLSearchParams(location.search);
        const f = Object.fromEntries(['cliente','producto','tm','turno','lote','desde','hasta']
        .map(k => [k, qs.get(k) || '']));
        if (!qs.toString()) {
        try { Object.assign(f, JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}')); } catch(e){}
        }

        F.cliente.value = f.cliente || '';
        F.tm.value      = f.tm || '';
        F.turno.value   = f.turno || '';
        F.lote.value    = f.lote || '';
        F.desde.value   = f.desde || '';
        F.hasta.value   = f.hasta || '';

        // 游녢 si hab칤a cliente guardado, cargamos sus productos y preseleccionamos
        if (f.cliente) {
        cargarProductosPorCliente(f.cliente, f.producto);
        } else {
        // si no hay cliente, dejamos el producto como "Todos"
        F.producto.value = '';
        }
    }

    function saveFilters(){
        const f = {
        cliente: F.cliente.value,
        producto: F.producto.value,
        tm: F.tm.value,
        turno: F.turno.value,
        lote: F.lote.value,
        desde: F.desde.value,
        hasta: F.hasta.value,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(f));
        history.replaceState(null, '', '?' + new URLSearchParams(f).toString());
    }

    // 游녢 cuando el usuario cambia cliente desde la UI
    F.cliente.addEventListener('change', () => {
        const cli = F.cliente.value;
        cargarProductosPorCliente(cli, '');
    });

    // ... 游녢 aqu칤 dejas el resto de tu c칩digo tal cual:
    // parseFechaLocal, unidadTiempo, destroyCharts, cargarDatos, buildLineChart, aplicar, etc.
    // solo acu칠rdate de llamar:
    loadFilters();
    aplicar();
    });
  </script>
</body>
</html>
