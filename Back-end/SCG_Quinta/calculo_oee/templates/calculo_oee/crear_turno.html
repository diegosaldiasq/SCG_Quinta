{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registrar Turno OEE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet" />

  <!-- Favicon -->
  <link rel="icon" href="{% static 'calculo_oee/images/logoquinta2.png' %}" />

  <style>
    :root{
      --text-input-field: #F7F7F7;
      --rojo-quinta: #B43C2C;
      --naranjo-quinta: #d07020;
      --naranjo-claro-quinta: #d4841c;
      --white: #FFFFFF;
      --black: #000000;
      --md: 16px;
    }

    *{ box-sizing:border-box; }
    html, body { width:100%; }
    body{
      margin:0;
      font-family:'Quicksand', sans-serif;
      background-image: url("{% static 'calculo_oee/images/Fondo.png' %}");
    }

    /* ===== Layout ===== */
    .login{
      min-height: 100dvh;
      display:grid;
      justify-content:center;
      align-content:start;
      padding: 16px;
      gap: 12px;
    }

    .logo{
      width: 200px;
      max-width: 70vw;
      height: auto;
      justify-self: center;
      margin-top: 10px;
    }

    .login_container{
      width: min(980px, 100%);
      margin: 0 auto;
      background: rgba(255,255,255,0.99);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }

    .title{
      color: var(--rojo-quinta);
      text-align:center;
      margin: 0 0 12px 0;
      font-size: 28px;
      font-weight: 700;
    }

    form{ display: grid; gap: 14px; }

    fieldset{
      border: 2px solid rgba(209,161,77,0.55);
      border-radius: 14px;
      padding: 14px;
      background: rgba(208,112,32,0.08);
    }

    legend{
      padding: 0 10px;
      color: var(--rojo-quinta);
      font-weight: 700;
    }

    /* ===== Inputs globales ===== */
    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="time"],
    select,
    textarea{
      width: 100%;
      background: var(--text-input-field);
      border: 1px solid rgba(199,199,199,0.85);
      border-radius: 10px;
      padding: 8px 10px;
      height: 40px;
      font-size: var(--md);
      outline: none;
    }

    textarea{ height:auto; min-height: 40px; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(209,161,77,0.85);
      box-shadow: 0 0 0 3px rgba(243,186,20,0.22);
    }

    /* ===== Tabla del form.as_table (SOLO ESTA) ===== */
    .form-table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(255,255,255,0.92);
      border-radius: 12px;
      overflow: visible; /* importante para selects iOS */
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .form-table td,
    .form-table th{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(199,199,199,0.6);
      vertical-align: middle;
    }

    .form-table th{
      text-align: left;
      font-weight: 700;
      width: 34%;
      white-space: nowrap;
    }

    .helptext{
      display:block;
      margin-top: 6px;
      font-size: 12px;
      color: rgba(0,0,0,0.65);
      line-height: 1.2;
    }

    /* ===== Botones ===== */
    .primary-button{
      background: var(--rojo-quinta);
      color: var(--white);
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: var(--md);
      font-weight: 700;
      cursor: pointer;
      transition: transform .05s ease, background-color .2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      white-space: nowrap;
    }
    .primary-button:hover{ background: var(--naranjo-quinta); }
    .primary-button:active{ transform: translateY(1px); }

    .botones{
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .botones .primary-button{ min-width: 220px; }

    /* ===== Tablas grandes (Productos/Detenciones/Mermas) ===== */
    .table-scroll{
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      background: rgba(255,255,255,0.75);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .data-table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0;
      background: transparent;
      min-width: 860px; /* fuerza scroll en m√≥vil */
    }

    .data-table th,
    .data-table td{
      padding: 8px 10px;
      border: 1px solid rgba(209,161,77,0.55);
      background: #fff;
      font-size: 0.92rem;
      vertical-align: middle;
      white-space: nowrap;
    }

    .data-table thead th{
      background: var(--naranjo-claro-quinta);
      color: var(--black);
      font-weight: 800;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .data-table select,
    .data-table input{
      min-width: 120px;
      height: 38px;
      border-radius: 10px;
      background: var(--text-input-field);
      border: 1px solid rgba(199,199,199,0.85);
      padding: 6px 10px;
      font-size: 0.92rem;
    }

    .btn-eliminar{
      background: #b33a2d;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-eliminar:hover{ filter: brightness(0.95); }

    /* ===== Responsive ===== */
    @media (max-width: 768px){
      body{ background-attachment: scroll; }
      .login{ padding: 12px; }
      .login_container{ padding: 14px; }
      .title{ font-size: 22px; }

      .botones{
        flex-direction: column;
        align-items: stretch;
      }
      .botones .primary-button{
        width: 100%;
        min-width: 0;
      }

      input, select, textarea{
        font-size: 16px; /* evita zoom iOS */
      }

      .data-table{ min-width: 920px; }
    }

    /* M√≥vil: SOLO el form-table se vuelve ‚Äútarjeta vertical‚Äù */
    @media (max-width: 600px){
      .title{ font-size: 20px; }
      .logo{ width: 170px; }
      .login_container{ width: 100%; }

      .form-table{
        display:block;
        box-shadow:none;
        background: transparent;
      }
      .form-table tbody{ display:block; }

      .form-table tr{
        display:block;
        padding: 12px 12px;
        border-bottom: 1px solid rgba(199,199,199,0.6);
        background: rgba(255,255,255,0.92);
        border-radius: 12px;
        margin-bottom: 10px;
      }

      .form-table th{
        display:block;
        width:100%;
        padding: 0 0 6px 0;
        white-space: normal;
      }

      .form-table td{
        display:block;
        width:100%;
        padding: 0;
        border-bottom: none;
      }
    }
  </style>
</head>

<body>
  <div class="login">
    <img src="{% static 'calculo_oee/images/logoquinta.png' %}" alt="Logo Quinta" class="logo" />

    <div class="login_container">
      <h1 class="title">üìã Crear Turno OEE</h1>

      <form method="post" action="{% url 'crear_turno' %}">
        {% csrf_token %}

        <!-- Datos del turno -->
        <fieldset>
          <legend>üìë Datos del Turno</legend>

          <!-- IMPORTANTE: as_table debe ir dentro de table -->
          <table class="form-table">
            {{ form.as_table }}
          </table>

          {% for hidden in form.hidden_fields %}
            {{ hidden }}
          {% endfor %}
        </fieldset>

        <!-- Productos -->
        <fieldset>
          <legend>üç∞ Productos</legend>

          <div class="table-scroll">
            <table id="tabla-productos" class="data-table">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Producto</th>
                  <th>C√≥digo</th>
                  <th>Planeado</th>
                  <th>Real</th>
                  <th>Comentarios</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px; display:flex; justify-content:flex-start;">
            <button type="button" class="primary-button" id="btn-agregar-producto">‚ûï Agregar Producto</button>
          </div>
        </fieldset>

        <!-- Detenciones -->
        <fieldset>
          <legend>‚õî Detenciones</legend>

          <div class="table-scroll">
            <table id="tabla-detenciones" class="data-table">
              <thead>
                <tr>
                  <th>Motivo</th>
                  <th>Hora inicio</th>
                  <th>Hora fin</th>
                  <th>Duraci√≥n (min)</th>
                  <th>Comentarios</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px; display:flex; justify-content:flex-start;">
            <button type="button" class="primary-button" onclick="agregarFilaDetencion()">‚ûï Agregar Detenci√≥n</button>
          </div>
        </fieldset>

        <!-- Mermas -->
        <fieldset>
          <legend>‚ôªÔ∏è Mermas</legend>

          <div class="table-scroll">
            <table id="tabla-reprocesos" class="data-table">
              <thead>
                <tr>
                  <th>Motivo</th>
                  <th>Cantidad</th>
                  <th>Comentarios</th>
                  <th>Acci√≥n</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="margin-top:10px; display:flex; justify-content:flex-start;">
            <button type="button" class="primary-button" onclick="agregarFilaReproceso()">‚ûï Agregar Reproceso</button>
          </div>
        </fieldset>

        <!-- Botones -->
        <div class="botones">
          <button type="submit" class="primary-button" onclick="return confirm('¬øEst√°s seguro de guardar este turno?')">üíæ Guardar Turno</button>
          <a href="{% url 'intermedio' %}" class="primary-button">üè† Volver al Inicio</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Templates invisibles -->
  <template id="fila-producto-template">
    <tr>
      <td>
        <select name="cliente_producto[]" class="cliente-en-producto" required>
          <option value="">--Seleccionar cliente--</option>
        </select>
      </td>
      <td>
        <select name="producto[]" class="producto-en-turno" required>
          <option value="">--Seleccionar producto--</option>
        </select>
      </td>
      <td>
        <input type="text" name="codigo[]" readonly class="codigo-en-turno" placeholder="Autocompleta" />
      </td>
      <td><input type="number" name="produccion_planeada[]" min="0" placeholder="Planeada" /></td>
      <td><input type="number" name="produccion_real[]" min="0" placeholder="Real" /></td>
      <td><input type="text" name="comentarios_producto[]" placeholder="Comentarios" /></td>
      <td><button type="button" class="btn-eliminar">Eliminar</button></td>
    </tr>
  </template>

  <script>
    const catalogo = {{ CATALOGO|safe|default:"{}" }};
    // Si no est√°s pasando CATALOGO desde la vista, puedes dejar tu objeto literal como lo ten√≠as.

    const motivosDetenciones = [
      "1-Colacion",
      "2-Falta insumo (bizcocho, panqueque, discos de hoja, hojarasca, etc.)",
      "3-Falta de prelistos",
      "4-Falta de crema, manjar o pastelera",
      "5-Falla mecanica",
      "6-Equipos fuera de servicio",
      "7-Preparacion de insumos",
      "8-Tortas reparadas",
      "9-Cambio de formato/producto",
      "10-Aseo de linea",
      "11-Mantencion preventiva",
      "12-Medicion de laboratorio",
      "13-Capacitaci√≥n",
      "14-Falta de personal",
      "15-Limpieza cabezal",
      "16-Ajuste de modulo"
    ];

    const motivosReprocesos = [
      "1-Defecto visual",
      "2-Error en etiquetado",
      "3-Desviaci√≥n de peso",
      "4-Contaminaci√≥n cruzada",
      "5-Caida al piso",
      "6-Insumo en mal estado"
    ];

    document.addEventListener('DOMContentLoaded', function() {
      // Detenciones
      function agregarFilaDetencion() {
        const opciones = motivosDetenciones.map(m => `<option value="${m}">${m}</option>`).join('');
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>
            <select name="motivo_det[]" required>
              <option value="">-- Seleccionar --</option>
              ${opciones}
            </select>
          </td>
          <td><input type="time" name="hora_inicio_det[]" required></td>
          <td><input type="time" name="hora_fin_det[]" required></td>
          <td><input type="number" name="duracion_det[]" readonly></td>
          <td><input type="text" name="comentarios_det[]" maxlength="200" placeholder="Comentarios adicionales"></td>
          <td><button type="button" class="btn-eliminar" onclick="this.closest('tr').remove()">Eliminar</button></td>
        `;
        document.querySelector("#tabla-detenciones tbody").append(fila);

        const hi = fila.querySelector('input[name="hora_inicio_det[]"]');
        const hf = fila.querySelector('input[name="hora_fin_det[]"]');
        const dur = fila.querySelector('input[name="duracion_det[]"]');

        function recalcular() {
          if (!hi.value || !hf.value) { dur.value = ''; return; }
          let [h1,m1] = hi.value.split(':').map(n=>+n);
          let [h2,m2] = hf.value.split(':').map(n=>+n);
          let t1 = h1*60 + m1, t2 = h2*60 + m2;
          if (t2 < t1) t2 += 24*60;
          dur.value = t2 - t1;
        }
        hi.addEventListener('change', recalcular);
        hf.addEventListener('change', recalcular);
      }

      // Reprocesos
      function agregarFilaReproceso() {
        const opciones = motivosReprocesos.map(m => `<option value="${m}">${m}</option>`).join('');
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>
            <select name="motivo_rep[]" required>
              <option value="">-- Seleccionar --</option>
              ${opciones}
            </select>
          </td>
          <td><input type="number" name="cantidad_rep[]" min="0" required></td>
          <td><input type="text" name="comentarios_rep[]" maxlength="200" placeholder="Comentarios adicionales"></td>
          <td><button type="button" class="btn-eliminar" onclick="this.closest('tr').remove()">Eliminar</button></td>
        `;
        document.querySelector("#tabla-reprocesos tbody").append(fila);
      }

      // Productos
      const tablaBodyProd = document.querySelector('#tabla-productos tbody');
      const templateProd = document.getElementById('fila-producto-template').content;
      const btnAgregarProd = document.getElementById('btn-agregar-producto');

      function llenarSelectCliente(select, seleccionado = '') {
        select.innerHTML = `<option value="">--Seleccionar cliente--</option>`;
        Object.keys(catalogo).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          if (c === seleccionado) opt.selected = true;
          select.appendChild(opt);
        });
      }

      function llenarSelectProducto(select, cliente, seleccionado = '') {
        select.innerHTML = `<option value="">--Seleccionar producto--</option>`;
        const lista = catalogo[cliente] || [];
        lista.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.producto;
          opt.textContent = item.producto;
          if (item.producto === seleccionado) opt.selected = true;
          select.appendChild(opt);
        });
      }

      function obtenerCodigo(cliente, producto) {
        const lista = catalogo[cliente] || [];
        const encontrado = lista.find(i => i.producto === producto);
        return encontrado ? encontrado.codigo : '';
      }

      function agregarFilaProductoInterna() {
        const clone = document.importNode(templateProd, true);
        const fila = clone.querySelector('tr');

        const selectCliente = fila.querySelector('.cliente-en-producto');
        const selectProducto = fila.querySelector('.producto-en-turno');
        const inputCodigo = fila.querySelector('.codigo-en-turno');
        const btnEliminar = fila.querySelector('.btn-eliminar');

        llenarSelectCliente(selectCliente);
        selectProducto.disabled = true;

        selectCliente.addEventListener('change', () => {
          const cliente = selectCliente.value;
          llenarSelectProducto(selectProducto, cliente);
          selectProducto.disabled = !cliente;
          inputCodigo.value = '';
        });

        selectProducto.addEventListener('change', () => {
          const cliente = selectCliente.value;
          inputCodigo.value = obtenerCodigo(cliente, selectProducto.value);
        });

        btnEliminar.addEventListener('click', () => fila.remove());
        tablaBodyProd.appendChild(fila);
      }

      btnAgregarProd.addEventListener('click', agregarFilaProductoInterna);

      // Exponer para onclick
      window.agregarFilaDetencion = agregarFilaDetencion;
      window.agregarFilaReproceso = agregarFilaReproceso;
      window.agregarFilaProducto = agregarFilaProductoInterna;
    });
  </script>
</body>
</html>