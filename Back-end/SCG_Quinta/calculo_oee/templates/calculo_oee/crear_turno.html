{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'calculo_oee/estilos_oee.css' %}">
    <link rel="icon" href="{% static 'calculo_oee/images/logoquinta2.png' %}">
    <title>Registrar Turno OEE</title>
    <script>
        const motivosDetenciones = [
            "Falla mec√°nica",
            "Cambio de formato",
            "Espera de insumos",
            "Aseo de l√≠nea",
            "Mantenci√≥n preventiva"
        ];

        const motivosReprocesos = [
            "Producto mal cerrado",
            "Defecto visual",
            "Error en etiquetado",
            "Desviaci√≥n de peso",
            "Contaminaci√≥n cruzada"
        ];

        function agregarFilaDetencion() {
            let opciones = motivosDetenciones.map(m => `<option value="${m}">${m}</option>`).join('');
            const fila = `
                <tr>
                    <td>
                        <select name="motivo_det[]" required>
                            <option value="">-- Seleccionar --</option>
                            ${opciones}
                        </select>
                    </td>
                    <td><input type="number" name="duracion_det[]" min="0" required></td>
                    <td><button type="button" onclick="this.closest('tr').remove()">Eliminar</button></td>
                </tr>`;
            document.querySelector("#tabla-detenciones tbody").insertAdjacentHTML("beforeend", fila);
        }

        function agregarFilaReproceso() {
            let opciones = motivosReprocesos.map(m => `<option value="${m}">${m}</option>`).join('');
            const fila = `
                <tr>
                    <td>
                        <select name="motivo_rep[]" required>
                            <option value="">-- Seleccionar --</option>
                            ${opciones}
                        </select>
                    </td>
                    <td><input type="number" name="cantidad_rep[]" min="0" required></td>
                    <td><button type="button" onclick="this.closest('tr').remove()">Eliminar</button></td>
                </tr>`;
            document.querySelector("#tabla-reprocesos tbody").insertAdjacentHTML("beforeend", fila);
        }
    </script>
    <script>
        // cat√°logo est√°tico: cliente ‚Üí lista de {producto, c√≥digo}
        const catalogo = {
            'Cliente A': [
                { producto: 'Prod A1', codigo: 'COD-A1' },
                { producto: 'Prod A2', codigo: 'COD-A2' },
            ],
            'Cliente B': [
                { producto: 'Prod B1', codigo: 'COD-B1' },
                { producto: 'Prod B2', codigo: 'COD-B2' },
            ],
            'Cliente C': [
                { producto: 'Prod C1', codigo: 'COD-C1' },
                { producto: 'Prod C2', codigo: 'COD-C2' },
            ],
        };
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const clienteSelect  = document.getElementById('id_cliente');
        const productoSelect = document.getElementById('id_producto');
        const codigoInput    = document.getElementById('id_codigo');

        // Al cambiar el cliente, recarga los productos
        clienteSelect.addEventListener('change', function() {
            const lista = catalogo[this.value] || [];
            // resetea dropdown de productos
            productoSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            // rellena con las opciones correspondientes
            lista.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.producto;
                opt.textContent = item.producto;
                productoSelect.append(opt);
            });
            // limpia el c√≥digo
            codigoInput.value = '';
        });

        // Al cambiar el producto, busca su c√≥digo
        productoSelect.addEventListener('change', function() {
            const lista = catalogo[clienteSelect.value] || [];
            const sel   = lista.find(item => item.producto === this.value);
            codigoInput.value = sel ? sel.codigo : '';
        });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    const inicio = document.getElementById('id_hora_inicio');
    const fin    = document.getElementById('id_hora_fin');
    const plano  = document.getElementById('id_tiempo_planeado');

    function calcularMinutos() {
        if (!inicio.value || !fin.value) {
        plano.value = '';
        return;
        }
        // parseamos HH:MM
        const [h1, m1] = inicio.value.split(':').map(n => parseInt(n, 10));
        const [h2, m2] = fin.value.split(':').map(n => parseInt(n, 10));
        let minutosInicio = h1 * 60 + m1;
        let minutosFin    = h2 * 60 + m2;
        // si fin es antes de inicio, asumimos paso de medianoche
        if (minutosFin < minutosInicio) {
        minutosFin += 24 * 60;
        }
        const diff = minutosFin - minutosInicio;
        plano.value = diff;
    }

    inicio.addEventListener('change', calcularMinutos);
    fin.   addEventListener('change', calcularMinutos);
    });
    </script>
</head>
<body>
    <div class="login">
        <img src="{% static 'calculo_oee/images/logoquinta.png' %}" alt="Logo Quinta" class="logo">
        <div class="login-container">
            <h1 class="title">üìã Crear Turno OEE</h1>

            <form method="post" action="{% url 'crear_turno' %}">
                {% csrf_token %}

                <!-- üìë Datos del Turno -->
                <fieldset>
                    <legend>üìë Datos del Turno</legend>
                    <table>
                        {{ form.as_table }}
                    </table>
                </fieldset>

                <!-- ‚õî Detenciones -->
                <fieldset>
                    <legend>‚õî Detenciones</legend>
                    <table id="tabla-detenciones">
                        <thead>
                            <tr>
                                <th>Motivo</th>
                                <th>Duraci√≥n (min)</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" onclick="agregarFilaDetencion()" class="primary-button">‚ûï Agregar Detenci√≥n</button>
                </fieldset>

                <!-- ‚ôªÔ∏è Reprocesos -->
                <fieldset>
                    <legend>‚ôªÔ∏è Reprocesos</legend>
                    <table id="tabla-reprocesos">
                        <thead>
                            <tr>
                                <th>Motivo</th>
                                <th>Cantidad</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" onclick="agregarFilaReproceso()" class="primary-button">‚ûï Agregar Reproceso</button>
                </fieldset>

                <!-- ‚úÖ Botones -->
                <div class="botones" >
                    <button type="submit" class="primary-button login-button" onclick="return confirm('¬øEst√°s seguro de guardar este turno?')">üíæ Guardar Turno</button>
                    <a href="{% url 'lista_turnos' %}" class="primary-button login-button">üö™ Cancelar</a>
                    <a href="{% url 'intermedio' %}" class="primary-button login-button">üè† Volver al Inicio</a>
                </div>
            </form>
        </div>
    </div>
</body>
</html>

