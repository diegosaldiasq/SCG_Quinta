{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- Estilos corporativos -->
    <link rel="stylesheet" type="text/css" href="{% static 'calculo_oee/estilos_oee.css' %}">
    <link rel="icon" href="{% static 'calculo_oee/images/logoquinta2.png' %}">
    <title>Grafico OEE - Dinámico</title>
</head>
<body>
    <div class="login">
        <img src="{% static 'calculo_oee/images/logoquinta.png' %}" alt="Logo Quinta" class="logo">
        <div class="login_container">
            <h1 class="title">Grafico OEE</h1>

            <!-- === 1. FILTROS (los mismos de antes) === -->
            <div class="filtros" style="display:grid; gap:.5rem; grid-template-columns: repeat(6, minmax(140px,1fr)); align-items:end; margin:12px 0;">
            <label>Semanas (multi)
                <select id="f_semanas" multiple size="4"></select>
            </label>
            <label>Año
                <select id="f_anios"></select>
            </label>
            <label>Líneas (multi)
                <select id="f_lineas" multiple size="4"></select>
            </label>
            <label>Turnos (multi)
                <select id="f_turnos" multiple size="3"></select>
            </label>
            <label>Desde
                <input type="date" id="f_desde">
            </label>
            <label>Hasta
                <input type="date" id="f_hasta">
            </label>
            </div>

            <div style="display:flex; gap:.5rem; margin-bottom:12px; flex-wrap: wrap;">
            <button id="btn_aplicar" class="primary-button">Aplicar filtros</button>
            <button id="btn_limpiar" class="primary-button" type="button">Limpiar</button>
            <button id="btn_sel_todo_sem" class="primary-button" type="button">Semanas: seleccionar todo</button>
            <button id="btn_sel_todo_lin" class="primary-button" type="button">Líneas: seleccionar todo</button>
            <button id="btn_sel_todo_tur" class="primary-button" type="button">Turnos: seleccionar todo</button>
            </div>

            <!-- === 2. GRÁFICO OEE === -->
            <div style="width:100%; height:380px; background:#fff; border-radius:8px; padding:8px;">
                <canvas id="graficoOEE"></canvas>
            </div>

            <!-- === 3. GRÁFICO DETENCIONES === -->
            <div style="width:100%; height:420px; background:#fff; border-radius:8px; padding:8px; margin-top:20px;">
                <canvas id="graficoDetenciones"></canvas>
            </div>

            <!-- === 4. SCRIPTS DE GRÁFICOS === -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
            document.addEventListener('DOMContentLoaded', () => {
            const ctxOEE = document.getElementById('graficoOEE')?.getContext('2d');
            const ctxDET = document.getElementById('graficoDetenciones')?.getContext('2d');
            if (!ctxOEE || !ctxDET) return;

            const $ = s => document.querySelector(s);
            const sSemanas = $('#f_semanas');
            const sAnios   = $('#f_anios');
            const sLineas  = $('#f_lineas');
            const sTurnos  = $('#f_turnos');
            const fDesde   = $('#f_desde');
            const fHasta   = $('#f_hasta');

            const btnAplicar = $('#btn_aplicar');
            const btnLimpiar = $('#btn_limpiar');
            const btnSelTodoSem = $('#btn_sel_todo_sem');
            const btnSelTodoLin = $('#btn_sel_todo_lin');
            const btnSelTodoTur = $('#btn_sel_todo_tur');

            let chartOEE, chartDET;

            // ========= UTILIDADES =========
            const fmtFecha = s => {
                const d = new Date(s);
                if (isNaN(d)) return s;
                return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
            };

            const getMultiValues = sel => Array.from(sel.selectedOptions).map(o => o.value).filter(Boolean);

            function buildURL(base) {
                const p = new URLSearchParams();
                for (const s of getMultiValues(sSemanas)) p.append('semana', s);
                if (sAnios.value) p.append('anio', sAnios.value);
                for (const l of getMultiValues(sLineas)) p.append('linea', l);
                for (const t of getMultiValues(sTurnos)) p.append('turno', t);
                if (fDesde.value) p.set('desde', fDesde.value);
                if (fHasta.value) p.set('hasta', fHasta.value);
                return p.toString() ? `${base}?${p}` : base;
            }

            async function cargarOpciones() {
                const urlOpt = "{% url 'resumen_turno_oee_opciones' %}";
                const r = await fetch(urlOpt, {credentials:'same-origin'});
                if (!r.ok) return;
                const {semanas=[], anios=[], lineas=[], turnos=[]} = await r.json();

                const llenarSelect = (sel, arr) => {
                sel.innerHTML = '';
                arr.sort((a,b)=>a-b).forEach(v=>{
                    const o=document.createElement('option');
                    o.value=v; o.textContent=v; sel.appendChild(o);
                });
                };
                llenarSelect(sSemanas,semanas);
                llenarSelect(sAnios,anios);
                llenarSelect(sLineas,lineas);
                llenarSelect(sTurnos,turnos);
                if (sAnios.options.length) sAnios.selectedIndex = sAnios.options.length-1;
            }

            // ========= GRÁFICO OEE =========
            async function cargarGraficoOEE() {
                const url = buildURL("{% url 'resumen_turno_oee_api' %}");
                const r = await fetch(url, {credentials:'same-origin'});
                if (!r.ok) return;
                const data = await r.json();
                if (!data.length) return;

                const labels = data.map(d => `${fmtFecha(d.fecha)} (${d.turno})`);
                const disponibilidad = data.map(d => d.disponibilidad || 0);
                const eficiencia = data.map(d => d.eficiencia || 0);
                const oee = data.map(d => d.oee || 0);
                const target = data.map(d => d.target || 0);

                if (chartOEE) chartOEE.destroy();
                chartOEE = new Chart(ctxOEE, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                    {label:'Disponibilidad',data:disponibilidad,borderColor:'blue',fill:false,tension:0.25},
                    {label:'Eficiencia',data:eficiencia,borderColor:'red',fill:false,tension:0.25},
                    {label:'OEE',data:oee,borderColor:'green',fill:false,tension:0.25},
                    {label:'Target',data:target,borderColor:'purple',borderDash:[6,6],fill:false}
                    ]
                },
                options: {
                    responsive:true, maintainAspectRatio:false,
                    plugins:{ legend:{position:'right'}, title:{display:true,text:'Tendencia OEE'} },
                    scales:{ y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}} }
                }
                });
            }

            // ========= GRÁFICO DETENCIONES =========
            async function cargarGraficoDetenciones() {
                const url = buildURL("{% url 'detenciones_turno_api' %}");
                const r = await fetch(url, {credentials:'same-origin'});
                if (!r.ok) return;
                const data = await r.json();
                if (!data.length) return;

                const barras = [...new Set(data.map(d => `${d.turno} ${fmtFecha(d.fecha)}`))];
                const motivos = [...new Set(data.map(d => d.motivo))];
                const palette = [
                '#1f77b4','#ff7f0e','#2ca02c','#9467bd','#8c564b',
                '#e377c2','#7f7f7f','#bcbd22','#17becf','#d62728'
                ];
                const M = {};
                for (const d of data) {
                const k = `${d.turno} ${fmtFecha(d.fecha)}`;
                M[k] ||= {}; M[k][d.motivo] = d.porcentaje;
                }

                const datasets = motivos.map((m,i)=>({
                label:m,
                data:barras.map(b=>M[b]?.[m]??0),
                backgroundColor:palette[i%palette.length],
                stack:'x'
                }));

                const hLine = {
                id:'hLine',
                afterDraw(chart,args,opts){
                    const {ctx,chartArea:{left,right},scales:{y}}=chart;
                    const yVal=opts.yValue??30;
                    const yPix=y.getPixelForValue(yVal);
                    ctx.save();ctx.beginPath();ctx.moveTo(left,yPix);ctx.lineTo(right,yPix);
                    ctx.lineWidth=2;ctx.strokeStyle='red';ctx.setLineDash([6,4]);ctx.stroke();ctx.restore();
                }
                };

                if (chartDET) chartDET.destroy();
                chartDET = new Chart(ctxDET, {
                type:'bar',
                data:{labels:barras,datasets},
                plugins:[hLine],
                options:{
                    responsive:true,maintainAspectRatio:false,
                    plugins:{
                    legend:{position:'right'},
                    title:{display:true,text:'% Detenciones por motivo (apilado 100%)'}
                    },
                    scales:{
                    x:{stacked:true,ticks:{autoSkip:false,maxRotation:0}},
                    y:{stacked:true,min:0,max:100,ticks:{callback:v=>v+'%'}}
                    },
                    hLine:{yValue:30}
                }
                });
            }

            // ========= EVENTOS =========
            btnSelTodoSem.onclick = ()=>Array.from(sSemanas.options).forEach(o=>o.selected=true);
            btnSelTodoLin.onclick = ()=>Array.from(sLineas.options).forEach(o=>o.selected=true);
            btnSelTodoTur.onclick = ()=>Array.from(sTurnos.options).forEach(o=>o.selected=true);

            btnAplicar.onclick = (e)=>{ e.preventDefault(); cargarGraficoOEE(); cargarGraficoDetenciones(); };
            btnLimpiar.onclick = ()=>{
                [sSemanas,sLineas,sTurnos].forEach(sel=>Array.from(sel.options).forEach(o=>o.selected=false));
                sAnios.selectedIndex=-1; fDesde.value=''; fHasta.value='';
                cargarGraficoOEE(); cargarGraficoDetenciones();
            };

            // Inicial
            (async()=>{ await cargarOpciones(); await cargarGraficoOEE(); await cargarGraficoDetenciones(); })();
            });
            </script>

            <!-- ✅ Botones -->
            <div class="botones">
                <a href="{% url 'intermedio' %}" class="primary-button login-button">🏠 Volver al Inicio</a>
            </div>
        </div>
    </div>
</body>
</html>
