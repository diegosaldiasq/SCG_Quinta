{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- Estilos corporativos -->
    <link rel="stylesheet" type="text/css" href="{% static 'calculo_oee/estilos_oee.css' %}">
    <link rel="icon" href="{% static 'calculo_oee/images/logoquinta2.png' %}">
    <title>Cerrar Turno - Producción Real</title>
</head>
<body>
    <div class="login">
        <img src="{% static 'calculo_oee/images/logoquinta.png' %}" alt="Logo Quinta" class="logo">
        <div class="login_container">
            <h1 class="title">Grafico OEE</h1>

            <!-- FILTROS -->
            <div class="filtros" style="display:grid; gap:.5rem; grid-template-columns: repeat(6, minmax(120px,1fr)); align-items:end; margin:12px 0;">
            <label>Semana
                <input type="number" id="f_semana" min="1" max="53" placeholder="1-53">
            </label>
            <label>Año
                <input type="number" id="f_anio" value="{{ lote.fecha|date:'Y' }}">
            </label>
            <label>Línea
                <input type="text" id="f_linea" placeholder="Gorreri pastelería">
            </label>
            <label>Turno
                <select id="f_turno">
                <option value="">Todos</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                </select>
            </label>
            <label>Desde
                <input type="date" id="f_desde">
            </label>
            <label>Hasta
                <input type="date" id="f_hasta">
            </label>
            </div>

            <div style="display:flex; gap:.5rem; margin-bottom:12px;">
            <button id="btn_aplicar" class="primary-button">Aplicar filtros</button>
            <button id="btn_limpiar" class="primary-button" type="button">Limpiar</button>
            </div>

            <!-- CONTENEDOR DEL GRÁFICO -->
            <div style="width:100%; height:380px;">
                <canvas id="graficoOEE" style="width:100%; height:100%;"></canvas>
            </div>

            <style>
                /* o pásalo a tu CSS */
                #graficoOEE { width:100%; height:100%; }
            </style>

            <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
            <script>
            document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('graficoOEE');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Controles
            const $ = sel => document.querySelector(sel);
            const fSemana = $('#f_semana');
            const fAnio   = $('#f_anio');
            const fLinea  = $('#f_linea');
            const fTurno  = $('#f_turno');
            const fDesde  = $('#f_desde');
            const fHasta  = $('#f_hasta');
            const btnAplicar = $('#btn_aplicar');
            const btnLimpiar = $('#btn_limpiar');

            let chart; // para destruir y recrear

            function buildURL() {
                const params = new URLSearchParams();
                if (fSemana.value) params.set('semana', fSemana.value);
                if (fAnio.value)   params.set('anio',   fAnio.value);
                if (fLinea.value)  params.set('linea',  fLinea.value);
                if (fTurno.value)  params.set('turno',  fTurno.value);
                if (fDesde.value)  params.set('desde',  fDesde.value);
                if (fHasta.value)  params.set('hasta',  fHasta.value);
                const base = "{% url 'resumen_turno_oee_api' %}";
                const qs   = params.toString();
                return qs ? `${base}?${qs}` : base;
            }

            function fmtFecha(s) {
                const d = new Date(s);
                if (isNaN(d)) return s;
                const dd = String(d.getDate()).padStart(2,'0');
                const mm = String(d.getMonth()+1).padStart(2,'0');
                const yy = d.getFullYear();
                return `${dd}-${mm}-${yy}`;
            }

            async function cargar() {
                const url = buildURL();
                try {
                const resp = await fetch(url, { credentials:'same-origin' });
                if (!resp.ok) {
                    console.error('API no OK:', resp.status, await resp.text());
                    return;
                }
                const data = await resp.json();
                if (!Array.isArray(data) || data.length === 0) {
                    // Limpia gráfico si no hay datos
                    if (chart) { chart.destroy(); chart = null; }
                    console.warn('Sin datos para los filtros.');
                    return;
                }

                const labels = data.map(d => `${fmtFecha(d.fecha)} (${d.turno})`);
                const disponibilidad = data.map(d => Number(d.disponibilidad ?? 0));
                const eficiencia     = data.map(d => Number(d.eficiencia ?? 0));
                const oee            = data.map(d => Number(d.oee ?? 0));
                const target         = data.map(d => Number(d.target ?? 0));

                // Re-render
                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                    labels,
                    datasets: [
                        { label: 'Disponibilidad', data: disponibilidad, borderColor: 'blue',  fill: false, tension: 0.25 },
                        { label: 'Eficiencia',     data: eficiencia,     borderColor: 'red',   fill: false, tension: 0.25 },
                        { label: 'OEE',            data: oee,            borderColor: 'green', fill: false, tension: 0.25 },
                        { label: 'Target',         data: target,         borderColor: 'purple', borderDash: [6,6], fill: false },
                    ]
                    },
                    options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'Tendencia OEE - Filtros aplicados' }
                    },
                    scales: { y: { beginAtZero: true, suggestedMax: 100, ticks: { callback: v => v + '%' } } }
                    }
                });
                } catch (err) {
                console.error('Error fetch/json:', err);
                }
            }

            // Eventos
            btnAplicar.addEventListener('click', (e) => { e.preventDefault(); cargar(); });
            btnLimpiar.addEventListener('click', () => {
                [fSemana, fAnio, fLinea, fTurno, fDesde, fHasta].forEach(i => i.value = '');
                cargar();
            });

            // Carga inicial
            cargar();
            });
            </script>
        </div>
    </div>

    <script>
        function confirmarEnvio() {
            return confirm("✅ ¿Estás seguro de guardar la producción real y cerrar el turno?");
        }
    </script>
</body>
</html>
