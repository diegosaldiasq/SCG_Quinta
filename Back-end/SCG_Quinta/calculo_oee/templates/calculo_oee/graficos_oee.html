{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- Estilos corporativos -->
    <link rel="stylesheet" type="text/css" href="{% static 'calculo_oee/estilos_oee.css' %}">
    <link rel="icon" href="{% static 'calculo_oee/images/logoquinta2.png' %}">
    <title>Grafico OEE - Din√°mico</title>
</head>
<body>
    <div class="login">
        <img src="{% static 'calculo_oee/images/logoquinta.png' %}" alt="Logo Quinta" class="logo">
        <div class="login_container">
            <h1 class="title">Grafico OEE</h1>

            <!-- === 1. FILTROS (los mismos de antes) === -->
            <div class="filtros" style="display:grid; gap:.5rem; grid-template-columns: repeat(6, minmax(140px,1fr)); align-items:end; margin:12px 0;">
            <label>Semanas (multi)
                <select id="f_semanas" multiple size="4"></select>
            </label>
            <label>A√±o
                <select id="f_anios"></select>
            </label>
            <label>L√≠neas (multi)
                <select id="f_lineas" multiple size="4"></select>
            </label>
            <label>Turnos (multi)
                <select id="f_turnos" multiple size="3"></select>
            </label>
            <label>Desde
                <input type="date" id="f_desde">
            </label>
            <label>Hasta
                <input type="date" id="f_hasta">
            </label>
            </div>

            <div style="display:flex; gap:.5rem; margin-bottom:12px; flex-wrap: wrap;">
                <button id="btn_aplicar" class="primary-button">Aplicar filtros</button>
                <button id="btn_limpiar" class="primary-button" type="button">Limpiar</button>
            </div>

            <!-- === 2. GR√ÅFICO OEE === -->
            <div style="width:100%; height:380px; background:#fff;">
                <canvas id="graficoOEE"></canvas>
            </div>

            <!-- === 4. SCRIPTS DE GR√ÅFICOS === -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
            <script>
            document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('graficoOEE')?.getContext('2d');
            if (!ctx) return;

            // Controles
            const $ = s => document.querySelector(s);
            const sSemanas = $('#f_semanas');
            const sAnios   = $('#f_anios');
            const sLineas  = $('#f_lineas');
            const sTurnos  = $('#f_turnos');
            const fDesde   = $('#f_desde');
            const fHasta   = $('#f_hasta');

            const btnAplicar = $('#btn_aplicar');
            const btnLimpiar = $('#btn_limpiar');
            const btnSelTodoSem = $('#btn_sel_todo_sem');
            const btnSelTodoLin = $('#btn_sel_todo_lin');
            const btnSelTodoTur = $('#btn_sel_todo_tur');

            let chart;

            // Utilidades
            const fmtFecha = s => {
                const d = new Date(s);
                if (isNaN(d)) return s;
                return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
            };

            function llenarSelect(select, valores, {placeholder=null, orden='asc'} = {}) {
                select.innerHTML = '';
                if (placeholder) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = placeholder;
                select.appendChild(opt);
                }
                const arr = [...valores];
                if (orden === 'asc') arr.sort((a,b) => (''+a).localeCompare((''+b), undefined, {numeric:true}));
                if (orden === 'desc') arr.sort((a,b) => (''+b).localeCompare((''+a), undefined, {numeric:true}));
                for (const v of arr) {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
                }
            }

            function getMultiValues(select) {
                return Array.from(select.selectedOptions || []).map(o => o.value).filter(Boolean);
            }

            function buildURL() {
                const base = "{% url 'resumen_turno_oee_api' %}";
                const p = new URLSearchParams();

                for (const s of getMultiValues(sSemanas)) p.append('semana', s);
                const anio = sAnios.value; if (anio) p.append('anio', anio);
                for (const l of getMultiValues(sLineas)) p.append('linea', l);
                for (const t of getMultiValues(sTurnos)) p.append('turno', t);
                if (fDesde.value) p.set('desde', fDesde.value);
                if (fHasta.value) p.set('hasta', fHasta.value);

                const qs = p.toString();
                return qs ? `${base}?${qs}` : base;
            }

            async function cargarOpciones() {
                const urlOpt = "{% url 'resumen_turno_oee_opciones' %}";
                const r = await fetch(urlOpt, {credentials:'same-origin'});
                if (!r.ok) {
                console.error('Opciones no OK:', r.status, await r.text());
                return;
                }
                const {semanas=[], anios=[], lineas=[], turnos=[]} = await r.json();

                llenarSelect(sSemanas, semanas, {orden:'asc'});
                llenarSelect(sAnios,   anios,   {orden:'desc'});   // a√±o m√°s reciente arriba
                llenarSelect(sLineas,  lineas,  {orden:'asc'});
                llenarSelect(sTurnos,  turnos,  {orden:'asc'});

                // Selecciones ‚Äúc√≥modas‚Äù por defecto (opcional):
                // Selecciona el a√±o m√°s reciente
                if (sAnios.options.length) sAnios.selectedIndex = 0;
            }

            async function cargarDatosYGraficar() {
                const url = buildURL();
                const resp = await fetch(url, {credentials:'same-origin'});
                if (!resp.ok) {
                console.error('API no OK:', resp.status, await resp.text());
                return;
                }
                const data = await resp.json();
                if (!Array.isArray(data) || data.length === 0) {
                if (chart) { chart.destroy(); chart = null; }
                console.warn('Sin datos con los filtros actuales');
                return;
                }

                const labels = data.map(d => `${fmtFecha(d.fecha)} (${d.turno})`);
                const disponibilidad = data.map(d => Number(d.disponibilidad ?? 0));
                const eficiencia     = data.map(d => Number(d.eficiencia ?? 0));
                const oee            = data.map(d => Number(d.oee ?? 0));
                const target         = data.map(d => Number(d.target ?? 0));

                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                    { label: 'Disponibilidad', data: disponibilidad, borderColor: 'blue',  fill: false, tension: 0.25 },
                    { label: 'Eficiencia',     data: eficiencia,     borderColor: 'red',   fill: false, tension: 0.25 },
                    { label: 'OEE',            data: oee,            borderColor: 'green', fill: false, tension: 0.25 },
                    { label: 'Target',         data: target,         borderColor: 'purple', borderDash: [6,6], fill: false },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: 'Tendencia OEE - Filtros' }
                    },
                    scales: { y: { beginAtZero: true, suggestedMax: 100, ticks: { callback: v => v + '%' } } }
                }
                });
            }

            // Botones seleccionar todo en multi-selects
            btnSelTodoSem.addEventListener('click', () => { Array.from(sSemanas.options).forEach(o => o.selected = true); });
            btnSelTodoLin.addEventListener('click', () => { Array.from(sLineas.options).forEach(o => o.selected = true); });
            btnSelTodoTur.addEventListener('click', () => { Array.from(sTurnos.options).forEach(o => o.selected = true); });

            // Aplicar / Limpiar
            btnAplicar.addEventListener('click', (e) => { e.preventDefault(); cargarDatosYGraficar(); });
            btnLimpiar.addEventListener('click', () => {
                [sSemanas, sLineas, sTurnos].forEach(sel => Array.from(sel.options).forEach(o => o.selected = false));
                sAnios.selectedIndex = -1;
                fDesde.value = ''; fHasta.value = '';
                cargarDatosYGraficar();
            });

            // Inicial
            (async () => {
                await cargarOpciones();
                await cargarDatosYGraficar();
            })();
            });
            </script>

            <!-- ‚úÖ Botones -->
            <div class="botones">
                <a href="{% url 'intermedio' %}" class="primary-button login-button">üè† Volver al Inicio</a>
            </div>
        </div>
    </div>
</body>
</html>
