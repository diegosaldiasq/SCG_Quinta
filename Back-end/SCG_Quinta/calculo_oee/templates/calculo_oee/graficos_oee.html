{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <!-- Estilos corporativos -->
    <link rel="stylesheet" type="text/css" href="{% static 'calculo_oee/estilos_oee.css' %}">
    <link rel="icon" href="{% static 'calculo_oee/images/logoquinta2.png' %}">
    <title>Grafico OEE - Dinámico</title>
</head>
<body>
    <div class="login">
        <img src="{% static 'calculo_oee/images/logoquinta.png' %}" alt="Logo Quinta" class="logo">
        <div class="login_container">
            <h1 class="title">Grafico OEE</h1>

            <!-- === 1. FILTROS (los mismos de antes) === -->
            <div class="filtros" style="display:grid; gap:.5rem; grid-template-columns: repeat(6, minmax(140px,1fr)); align-items:end; margin:12px 0;">
            <label>Semanas (multi)
                <select id="f_semanas" multiple size="4"></select>
            </label>
            <label>Año
                <select id="f_anios"></select>
            </label>
            <label>Líneas (multi)
                <select id="f_lineas" multiple size="4"></select>
            </label>
            <label>Turnos (multi)
                <select id="f_turnos" multiple size="3"></select>
            </label>
            <label>Desde
                <input type="date" id="f_desde">
            </label>
            <label>Hasta
                <input type="date" id="f_hasta">
            </label>
            </div>

            <div style="display:flex; gap:.5rem; margin-bottom:12px; flex-wrap: wrap;">
                <button id="btn_aplicar" class="primary-button">Aplicar filtros</button>
                <button id="btn_limpiar" class="primary-button" type="button">Limpiar</button>
                <button id="btn_sel_todo_sem" class="primary-button" type="button">Semanas: seleccionar todo</button>
                <button id="btn_sel_todo_lin" class="primary-button" type="button">Líneas: seleccionar todo</button>
                <button id="btn_sel_todo_tur" class="primary-button" type="button">Turnos: seleccionar todo</button>
            </div>

            <!-- === 2. GRÁFICO OEE === -->
            <div style="width:100%; height:380px; background:#fff;">
                <canvas id="graficoOEE"></canvas>
            </div>

            <!-- === 4. SCRIPTS DE GRÁFICOS === -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
            document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('graficoOEE')?.getContext('2d');
            if (!ctx) return;

            // ====== Filtros (mismos IDs que ya usas) ======
            const $ = s => document.querySelector(s);
            const sSemanas = $('#f_semanas');
            const sAnios   = $('#f_anios');
            const sLineas  = $('#f_lineas');
            const sTurnos  = $('#f_turnos');
            const fDesde   = $('#f_desde');
            const fHasta   = $('#f_hasta');

            const btnAplicar   = $('#btn_aplicar');
            const btnLimpiar   = $('#btn_limpiar');
            const btnSelTodoSem= $('#btn_sel_todo_sem');
            const btnSelTodoLin= $('#btn_sel_todo_lin');
            const btnSelTodoTur= $('#btn_sel_todo_tur');

            let chart;

            // ========= Utilidades de filtros (igual que en detenciones) =========
            const getMultiValues = sel => Array.from(sel.selectedOptions).map(o => o.value).filter(Boolean);

            function buildParams() {
                const p = new URLSearchParams();
                for (const s of getMultiValues(sSemanas)) p.append('semana', s);
                if (sAnios.value) p.append('anio', sAnios.value);
                for (const l of getMultiValues(sLineas)) p.append('linea', l);
                for (const t of getMultiValues(sTurnos)) p.append('turno', t);
                if (fDesde.value) p.set('desde', fDesde.value);
                if (fHasta.value) p.set('hasta', fHasta.value);
                return p;
            }

            function buildURL() {
                const base = "{% url 'resumen_turno_oee_api' %}";
                const p = buildParams();
                return p.toString() ? `${base}?${p}` : base;
            }

            async function cargarOpciones() {
                const urlOpt = "{% url 'resumen_turno_oee_opciones' %}";
                const r = await fetch(urlOpt, {credentials:'same-origin'});
                if (!r.ok) return;
                const {semanas=[], anios=[], lineas=[], turnos=[]} = await r.json();
                const fill = (sel, arr, desc=false) => {
                sel.innerHTML = '';
                const lista = [...arr].sort((a,b)=> (''+(desc?b:a)).localeCompare(''+(desc?a:b), undefined, {numeric:true}));
                for (const v of lista) {
                    const o = document.createElement('option');
                    o.value = v; o.textContent = v; sel.appendChild(o);
                }
                };
                fill(sSemanas, semanas);
                fill(sAnios,   anios, true);   // años descendente
                fill(sLineas,  lineas);
                fill(sTurnos,  turnos);
                if (sAnios.options.length && !new URLSearchParams(location.search).has('anio')) {
                sAnios.selectedIndex = 0; // año más reciente por defecto si no viene en URL
                }
            }

            function aplicarFiltrosDesdeURL() {
                const params = new URLSearchParams(location.search);
                const markMulti = (sel, arr) => {
                const S = new Set(arr);
                Array.from(sel.options).forEach(o => o.selected = S.has(o.value));
                };
                const semanas = params.getAll('semana'); if (semanas.length) markMulti(sSemanas, semanas);
                const anio = params.get('anio'); if (anio) sAnios.value = anio;
                const lineas = params.getAll('linea'); if (lineas.length) markMulti(sLineas, lineas);
                const turnos = params.getAll('turno'); if (turnos.length) markMulti(sTurnos, turnos);
                const desde = params.get('desde'); if (desde) fDesde.value = desde;
                const hasta = params.get('hasta'); if (hasta) fHasta.value = hasta;
            }

            const fmtFecha = s => {
                const d = new Date(s);
                if (isNaN(d)) return s;
                return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
            };

            async function cargarDatosYGraficar() {
                const url = buildURL();
                const resp = await fetch(url, {credentials:'same-origin'});
                if (!resp.ok) { console.error('API OEE:', resp.status, await resp.text()); return; }
                const data = await resp.json();
                if (!Array.isArray(data) || !data.length) {
                if (chart) { chart.destroy(); chart = null; }
                console.warn('Sin datos OEE'); return;
                }

                // Orden estable por fecha, turno
                data.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha) || String(a.turno).localeCompare(String(b.turno)));

                const labels  = data.map(d => `${fmtFecha(d.fecha)} (${d.turno})`);
                const disp    = data.map(d => Number(d.disponibilidad ?? 0));
                const efic    = data.map(d => Number(d.eficiencia ?? 0));
                const oee     = data.map(d => Number(d.oee ?? 0));
                const target  = data.map(d => Number(d.target ?? 0));
                const loteIds = data.map(d => d.lote_id); // 👈 para navegar al resumen

                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                    { label: 'Disponibilidad', data: disp,   borderColor: 'blue',  fill: false, tension: 0.25 },
                    { label: 'Eficiencia',     data: efic,   borderColor: 'red',   fill: false, tension: 0.25 },
                    { label: 'OEE',            data: oee,    borderColor: 'green', fill: false, tension: 0.25 },
                    { label: 'Target',         data: target, borderColor: 'purple', borderDash: [6,6], fill: false },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', intersect: true },
                    // 👇 Click en un punto → resumen_turno/<lote_id>?next=<ruta+query actual>
                    onClick(evt, elements) {
                    if (!elements.length) return;
                    const el = elements[0]; // {datasetIndex, index}
                    const idx = el.index;
                    const lid = loteIds[idx];
                    if (lid) {
                        const urlRes = `{% url 'resumen_turno' 0 %}`.replace('0', lid);
                        const returnTo = window.location.pathname + window.location.search;
                        window.location.href = `${urlRes}?next=${encodeURIComponent(returnTo)}`;
                    }
                    },
                    plugins: {
                    legend: { position: 'right' },
                    title:  { display: true, text: 'Tendencia OEE - Filtros' },
                    tooltip:{ mode:'index', intersect:false }
                    },
                    scales: {
                    x: { ticks: { autoSkip: true, maxRotation: 60, minRotation: 60 } },
                    y: { beginAtZero: true, suggestedMax: 100, ticks: { callback: v => v + '%' } }
                    }
                }
                });
            }

            // ====== Botones y persistencia en URL ======
            btnSelTodoSem.onclick = ()=>Array.from(sSemanas.options).forEach(o=>o.selected=true);
            btnSelTodoLin.onclick = ()=>Array.from(sLineas.options).forEach(o=>o.selected=true);
            btnSelTodoTur.onclick = ()=>Array.from(sTurnos.options).forEach(o=>o.selected=true);

            btnAplicar.onclick = e => {
                e.preventDefault();
                const p = buildParams();
                history.replaceState(null, '', p.toString() ? `?${p}` : window.location.pathname); // persiste filtros
                cargarDatosYGraficar();
            };

            btnLimpiar.onclick = () => {
                [sSemanas,sLineas,sTurnos].forEach(sel=>Array.from(sel.options).forEach(o=>o.selected=false));
                sAnios.selectedIndex = -1; fDesde.value=''; fHasta.value='';
                history.replaceState(null, '', window.location.pathname); // limpia query
                cargarDatosYGraficar();
            };

            // ====== Inicial ======
            (async () => {
                await cargarOpciones();
                aplicarFiltrosDesdeURL();  // restaura desde la URL si volviste de resumen
                await cargarDatosYGraficar();
            })();
            });
            </script>

            <!-- ✅ Botones -->
            <div class="botones">
                <a href="{% url 'redireccionar_intermedio_4' %}" class="primary-button login-button">🏠 Volver al Inicio</a>
            </div>
        </div>
    </div>
</body>
</html>
